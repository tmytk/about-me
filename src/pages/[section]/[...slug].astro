---
import { getCollection, getEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import MarkdownContent from "../../components/MarkdownContent.astro";
import PageFrame from "../../components/PageFrame.astro";
import SearchInput from "../../components/SearchInput.astro";
import SearchFilter from "../../components/SearchFilter.astro";
import TreeList from "../../components/TreeList.astro";
import { SITE_DOMAIN } from "../../lib/constant";
import { buildListing } from "../../lib/tree";
import { SECTIONS } from "../../lib/sections";

export const getStaticPaths = async () => {
    const paths = [];

    for (const section of SECTIONS) {
        const entries = await getCollection(section);
        const folderSet = new Set();
        for (const entry of entries) {
            const parts = entry.slug.split("/").filter(Boolean);
            if (parts.length === 0) continue;
            paths.push({ params: { section, slug: parts.join("/") } });
            for (let i = 1; i < parts.length; i += 1) {
                folderSet.add(parts.slice(0, i).join("/"));
            }
        }
        for (const folder of folderSet) {
            paths.push({ params: { section, slug: folder } });
        }
    }

    return paths;
};

const { section, slug } = Astro.params;
if (!SECTIONS.includes(section)) {
    throw new Error("Not found");
}

const slugParts = Array.isArray(slug) ? slug : slug ? slug.split("/") : [];
const slugPath = slugParts.join("/");

const entry = slugPath
    ? await getEntry({ collection: section, slug: slugPath })
    : null;
let Content = null;
if (entry) {
    ({ Content } = await entry.render());
}

const crumbsBase = [
    { label: "~", href: "/" },
    { label: section, href: `/${section}` },
];

const crumbs = entry
    ? [
          ...crumbsBase,
          ...slugParts.slice(0, -1).map((part, index) => ({
              label: part,
              href: `/${section}/${slugParts.slice(0, index + 1).join("/")}`,
          })),
          { label: entry.data.title },
      ]
    : [
          ...crumbsBase,
          ...slugParts.map((part, index) => ({
              label: part,
              href: `/${section}/${slugParts.slice(0, index + 1).join("/")}`,
          })),
      ];

let items = [];
if (!entry) {
    const entries = await getCollection(section);
    const prefix = `${slugPath}/`;
    items = buildListing(entries, `/${section}`, prefix);
}
---

<BaseLayout title={`${entry ? entry.data.title : section} | ${SITE_DOMAIN}`}>
    <PageFrame>
        <Breadcrumbs items={crumbs} />
        {entry ? (
            <MarkdownContent>
                <Content />
            </MarkdownContent>
        ) : (
            <>
                <SearchInput id="section-search" placeholder="Search titles" />
                <SearchFilter />
                <TreeList items={items} emptyMessage="No markdown yet." showDesc={false} />
            </>
        )}
    </PageFrame>
</BaseLayout>
