---
import { getCollection, getEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import MarkdownContent from "../../components/MarkdownContent.astro";
import PageFrame from "../../components/PageFrame.astro";
import SearchInput from "../../components/SearchInput.astro";
import TreeList from "../../components/TreeList.astro";
import { SITE_DOMAIN } from "../../lib/constant";
import { buildListing } from "../../lib/tree";

export const getStaticPaths = async () => {
    const sections = ["tech", "random", "music"];
    const paths = [];

    for (const section of sections) {
        const entries = await getCollection(section);
        const folderSet = new Set();
        for (const entry of entries) {
            const parts = entry.slug.split("/").filter(Boolean);
            if (parts.length === 0) continue;
            paths.push({ params: { section, slug: parts.join("/") } });
            for (let i = 1; i < parts.length; i += 1) {
                folderSet.add(parts.slice(0, i).join("/"));
            }
        }
        for (const folder of folderSet) {
            paths.push({ params: { section, slug: folder } });
        }
    }

    return paths;
};

const { section, slug } = Astro.params;
const allowed = ["tech", "random", "music"];
if (!allowed.includes(section)) {
    throw new Error("Not found");
}

const slugParts = Array.isArray(slug) ? slug : slug ? slug.split("/") : [];
const slugPath = slugParts.join("/");

const entry = slugPath
    ? await getEntry({ collection: section, slug: slugPath })
    : null;
let Content = null;
if (entry) {
    ({ Content } = await entry.render());
}

const crumbsBase = [
    { label: "~", href: "/" },
    { label: section, href: `/${section}` },
];

const crumbs = entry
    ? [
          ...crumbsBase,
          ...slugParts.slice(0, -1).map((part, index) => ({
              label: part,
              href: `/${section}/${slugParts.slice(0, index + 1).join("/")}`,
          })),
          { label: entry.data.title },
      ]
    : [
          ...crumbsBase,
          ...slugParts.map((part, index) => ({
              label: part,
              href: `/${section}/${slugParts.slice(0, index + 1).join("/")}`,
          })),
      ];

let items = [];
if (!entry) {
    const entries = await getCollection(section);
    const prefix = `${slugPath}/`;
    items = buildListing(entries, `/${section}`, prefix);
}
---

<BaseLayout title={`${entry ? entry.data.title : section} | ${SITE_DOMAIN}`}>
    <PageFrame>
        <Breadcrumbs items={crumbs} />
        {entry ? (
            <MarkdownContent>
                <Content />
            </MarkdownContent>
        ) : (
            <>
                <SearchInput id="section-search" placeholder="Search titles" />
                <TreeList items={items} emptyMessage="No markdown yet." showDesc={false} />
            </>
        )}
    </PageFrame>
</BaseLayout>

{entry ? null : (
    <script is:inline>
        {`
        const input = document.querySelector("#section-search");
        const sections = document.querySelectorAll("[data-section]");

        const filterItems = () => {
            const query = input.value.trim().toLowerCase();
            sections.forEach((section) => {
                const cards = section.querySelectorAll("[data-title]");
                let visibleCount = 0;
                cards.forEach((card) => {
                    const title = card.getAttribute("data-title") || "";
                    const match = title.toLowerCase().includes(query);
                    card.style.display = match ? "" : "none";
                    if (match) visibleCount += 1;
                });
                const empty = section.querySelector("[data-empty]");
                if (empty) {
                    empty.style.display = visibleCount === 0 ? "" : "none";
                }
            });
        };

        if (input) {
            input.addEventListener("input", filterItems);
        }
        `}
    </script>
)}
